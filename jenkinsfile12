pipeline {
    agent any
    environment {
        // Define your AWS region and ECR repository URL
        AWS_REGION = 'ap-south-1'
        ECR_REPO_URL = '748883639478.dkr.ecr.ap-south-1.amazonaws.com'
        dockerImage = "webapp01"
        ECR_REPO = '748883639478.dkr.ecr.ap-south-1.amazonaws.com/webapp01'

    }  
    stages {
        stage('Maven Build') {
            steps {
                // Maven build
                script {
                    def mvnHome = tool 'maven'
                    def mvnCMD = "${mvnHome}/bin/mvn"

                    sh "${mvnCMD} clean install"
                    // Add additional Maven goals or options as needed
                }
            }
        }
        stage('Docker Build') {
            steps {
                script {
                    // Define Docker image name and tag
                    def dockerTag = "${env.BUILD_NUMBER}"
                    // Build and tag the Docker image
                    sh "docker build -t ${dockerImage}:${dockerTag} ."  
                    // Push the Docker image to ECR
                    //sh "docker push ${ECR_REPO_URL}:${dockerTag}"
                }
            }
        }

        stage('Remove Previous Docker Image') {
            steps {
                script {
                    // Define Docker image name
                    def previousTag = env.BUILD_NUMBER.toInteger() - 1
                    // Remove the previous Docker image
                    sh "docker rmi -f ${dockerImage}:${previousTag}"
                }
            }
        }
        }
